{% extends 'base.html' %}
{% load static %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'css/dashboard.css' %}" />
<style>
  /* Upload container styling */
  .upload-container {
    background: white;
    border-radius: 10px;
    box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    padding: 40px;
    max-width: 800px;
    margin: 20px auto;
  }
  
  .upload-header {
    text-align: center;
    margin-bottom: 30px;
  }
  
  .upload-header h1 {
    color: #333;
    margin-bottom: 10px;
    font-size: 28px;
  }
  
  .upload-header .subtitle {
    color: #666;
    font-size: 14px;
  }
  
  .upload-area {
    border: 2px dashed #ddd;
    border-radius: 10px;
    padding: 60px 40px;
    text-align: center;
    transition: all 0.3s ease;
    background: #fafafa;
    cursor: pointer;
    margin-bottom: 20px;
  }
  
  .upload-area:hover {
    border-color: #667eea;
    background: #f0f0ff;
  }
  
  .upload-area.dragover {
    border-color: #667eea;
    background: #e8e8ff;
    transform: scale(1.02);
  }
  
  .upload-icon {
    font-size: 64px;
    color: #667eea;
    margin-bottom: 20px;
  }
  
  .upload-text {
    color: #333;
    font-size: 16px;
    margin-bottom: 10px;
    font-weight: 500;
  }
  
  .upload-hint {
    color: #999;
    font-size: 13px;
  }
  
  input[type="file"] {
    display: none;
  }
  
  .file-selected {
    background: #e8f5e9;
    border: 1px solid #4caf50;
    border-radius: 8px;
    padding: 15px;
    margin: 20px 0;
    color: #2e7d32;
    display: none;
    align-items: center;
    justify-content: space-between;
  }
  
  .file-selected.show {
    display: flex;
  }
  
  .file-info {
    display: flex;
    align-items: center;
    gap: 10px;
  }
  
  .file-icon {
    font-size: 24px;
  }
  
  .file-name {
    font-weight: 500;
  }
  
  .remove-file {
    background: none;
    border: none;
    color: #d32f2f;
    cursor: pointer;
    font-size: 20px;
    padding: 5px;
  }
  
  .submit-btn {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
    border: none;
    padding: 14px 40px;
    border-radius: 8px;
    font-size: 16px;
    font-weight: 500;
    cursor: pointer;
    width: 100%;
    transition: all 0.3s;
    display: none;
  }
  
  .submit-btn.show {
    display: block;
  }
  
  .submit-btn:hover {
    transform: translateY(-2px);
    box-shadow: 0 5px 15px rgba(102, 126, 234, 0.3);
  }
  
  .submit-btn:active {
    transform: translateY(0);
  }
  
  .submit-btn:disabled {
    background: #ccc;
    cursor: not-allowed;
    transform: none;
  }
  
  .processing {
    display: none;
    text-align: center;
    padding: 20px;
  }
  
  .processing.show {
    display: block;
  }
  
  .spinner {
    border: 3px solid #f3f3f3;
    border-top: 3px solid #667eea;
    border-radius: 50%;
    width: 40px;
    height: 40px;
    animation: spin 1s linear infinite;
    margin: 0 auto 15px;
  }
  
  @keyframes spin {
    0% { transform: rotate(0deg); }
    100% { transform: rotate(360deg); }
  }
  
  .processing-text {
    color: #667eea;
    font-weight: 500;
  }
  
  /* Toast/Message styling */
  .message {
    padding: 15px 20px;
    border-radius: 8px;
    margin: 20px 0;
    display: none;
    align-items: center;
    gap: 10px;
  }
  
  .message.show {
    display: flex;
  }
  
  .message.success {
    background: #e8f5e9;
    border: 1px solid #4caf50;
    color: #2e7d32;
  }
  
  .message.error {
    background: #ffebee;
    border: 1px solid #ef5350;
    color: #c62828;
  }
  
  .message-icon {
    font-size: 20px;
  }
  
  .message-text {
    flex: 1;
  }

  /* Main content adjustment for better centering */
  .main-content {
    display: flex;
    flex-direction: column;
    padding: 20px;
  }
</style>
{% endblock %}

{% block content %}
<div class="dashboard-container">
  <!-- Sidebar -->
  <aside class="sidebar">
    <ul>
      <li><a href="{% url 'dashboard' %}">ACARS</a></li>
      <li><a href="{% url 'cpat_completion_records' %}">CPAT</a></li>
      <li><a href="{% url 'fdm_dashboard' %}">FDM</a></li>
      <li><a href="{% url 'crew_allowance_list' %}">WB-CAS</a></li>
      <li><a href="https://10ay.online.tableau.com/#/site/rwandairanalytics/views/On-TimePerformance/ExecutiveSummary?:iid=3" target="_blank">OTP</a></li>
      <li><a href="{% url 'qatar_apis_dashboard' %}">Qatar APIS</a></li>
      <li><a href="{% url 'jeppessen_dashboard' %}">Jeppessen Crew</a></li>
      <li><a href="{% url 'crew_transport_dashboard' %}" class="active">CREW-TRA</a></li>
    </ul>
  </aside>

  <!-- Main Content -->
  <div class="main-content">
    <div class="upload-container">
      <div class="upload-header">
        <h1>Crew Pick-Up Report Processor</h1>
        <p class="subtitle">Upload your Excel file to generate a cleaned crew pick-up report</p>
      </div>
      
      <form id="uploadForm" enctype="multipart/form-data">
        {% csrf_token %}
        
        <div class="upload-area" id="uploadArea">
          <div class="upload-icon">ðŸ“„</div>
          <p class="upload-text">Click to select or drag and drop your Excel file here</p>
          <p class="upload-hint">Supported formats: .xls, .xlsx (Excel XML format)</p>
          <input type="file" name="file" id="fileInput" accept=".xls,.xlsx,.xml">
        </div>
        
        <div class="file-selected" id="fileSelected">
          <div class="file-info">
            <span class="file-icon">ðŸ“Ž</span>
            <span class="file-name" id="fileName"></span>
          </div>
          <button type="button" class="remove-file" id="removeFile">âœ•</button>
        </div>
        
        <div class="processing" id="processing">
          <div class="spinner"></div>
          <p class="processing-text">Processing your file...</p>
        </div>
        
        <button type="submit" class="submit-btn" id="submitBtn">
          Process and Download Report
        </button>
      </form>
      
      <div class="message" id="message">
        <span class="message-icon" id="messageIcon"></span>
        <span class="message-text" id="messageText"></span>
      </div>
    </div>
  </div>
</div>

<script>
  const uploadArea = document.getElementById('uploadArea');
  const fileInput = document.getElementById('fileInput');
  const fileSelected = document.getElementById('fileSelected');
  const fileName = document.getElementById('fileName');
  const submitBtn = document.getElementById('submitBtn');
  const uploadForm = document.getElementById('uploadForm');
  const processing = document.getElementById('processing');
  const message = document.getElementById('message');
  const messageIcon = document.getElementById('messageIcon');
  const messageText = document.getElementById('messageText');
  const removeFile = document.getElementById('removeFile');
  
  // Click to select file
  uploadArea.addEventListener('click', () => {
    fileInput.click();
  });
  
  // File selected
  fileInput.addEventListener('change', (e) => {
    if (e.target.files.length > 0) {
      const file = e.target.files[0];
      fileName.textContent = file.name;
      fileSelected.classList.add('show');
      submitBtn.classList.add('show');
      message.classList.remove('show');
    }
  });
  
  // Remove file
  removeFile.addEventListener('click', () => {
    fileInput.value = '';
    fileSelected.classList.remove('show');
    submitBtn.classList.remove('show');
    message.classList.remove('show');
  });
  
  // Drag and drop
  uploadArea.addEventListener('dragover', (e) => {
    e.preventDefault();
    uploadArea.classList.add('dragover');
  });
  
  uploadArea.addEventListener('dragleave', () => {
    uploadArea.classList.remove('dragover');
  });
  
  uploadArea.addEventListener('drop', (e) => {
    e.preventDefault();
    uploadArea.classList.remove('dragover');
    
    const files = e.dataTransfer.files;
    if (files.length > 0) {
      fileInput.files = files;
      fileName.textContent = files[0].name;
      fileSelected.classList.add('show');
      submitBtn.classList.add('show');
      message.classList.remove('show');
    }
  });
  
  // Form submission
  uploadForm.addEventListener('submit', async (e) => {
    e.preventDefault();
    
    if (!fileInput.files.length) {
      showMessage('Please select a file', 'error');
      return;
    }
    
    const formData = new FormData();
    formData.append('file', fileInput.files[0]);
    
    // Get CSRF token
    const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]').value;
    
    processing.classList.add('show');
    submitBtn.disabled = true;
    submitBtn.style.display = 'none';
    message.classList.remove('show');
    
    try {
      const response = await fetch('{% url "upload_transport_file" %}', {
        method: 'POST',
        body: formData,
        headers: {
          'X-CSRFToken': csrfToken,
        }
      });
      
      if (response.ok) {
        // Get the blob
        const blob = await response.blob();
        
        // Get filename from header
        const contentDisposition = response.headers.get('Content-Disposition');
        let downloadFilename = 'Crew_Report.xlsx';
        
        if (contentDisposition) {
          const filenameMatch = contentDisposition.match(/filename[^;=\n]*=((['"]).*?\2|[^;\n]*)/);
          if (filenameMatch && filenameMatch[1]) {
            downloadFilename = filenameMatch[1].replace(/['"]/g, '');
          }
        }
        
        // Create download link
        const url = window.URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = downloadFilename;
        document.body.appendChild(a);
        a.click();
        window.URL.revokeObjectURL(url);
        a.remove();
        
        showMessage('Report generated successfully! Download started.', 'success');
        
        // Reset form
        uploadForm.reset();
        fileSelected.classList.remove('show');
        submitBtn.classList.remove('show');
        
      } else {
        let errorMessage = 'Processing failed';
        
        // Try to parse JSON error
        try {
          const error = await response.json();
          errorMessage = error.error || errorMessage;
        } catch (e) {
          // If not JSON, try to get text
          const errorText = await response.text();
          if (errorText) {
            errorMessage = 'Server error: ' + errorText.substring(0, 100);
          }
        }
        
        showMessage(errorMessage, 'error');
      }
      
    } catch (error) {
      showMessage('Network error: ' + error.message, 'error');
      console.error('Upload error:', error);
      
    } finally {
      processing.classList.remove('show');
      submitBtn.disabled = false;
      submitBtn.style.display = 'block';
    }
  });
  
  function showMessage(text, type) {
    messageText.textContent = text;
    message.className = 'message show ' + type;
    messageIcon.textContent = type === 'error' ? 'âŒ' : 'âœ…';
    
    // Auto-hide success messages after 5 seconds
    if (type === 'success') {
      setTimeout(() => {
        message.classList.remove('show');
      }, 5000);
    }
  }
</script>
{% endblock %}